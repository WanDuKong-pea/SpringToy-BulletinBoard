<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>Bulletin Board</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <style>
        .form-control {
            font-size: 13px;

        }

        a {
            visibility: inherit;
            color: black;
            text-decoration: none;
        }

        .form-control:focus {
            box-shadow: 0 0 0 0px;
            border-color: #FFC107;
        }

        .fs-13{
            font-size: 13px;
        }

    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        // 날짜를 변환 함수
        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        $(document).ready(function() {
            $("#commentButton").click(function() {
                var comment = $("#commentData").val();
                var boardId = $("#boardId").val();

                $.ajax({
                    type: "GET",
                    url: "/comment/write",
                    data: { comment: comment, boardId: boardId },
                    success: function(response) {
                        // 기존 내용 모두 지우기
                        var tableBody = $("#commentTableBody");
                        tableBody.empty();
                        $("#commentData").val('');

                        var comments = response.comments;
                        var replies = response.replies;

                        comments.forEach(function(comment) {
                            var row = $("<tr>");
                            var writerCell = $("<td>").html("<strong>" + comment.commenter + ":");
                            var commentCell = $("<td>").text(comment.comment);
                            var dateCell = $("<td>").text(formatDate(comment.regDate));

                            row.append(writerCell, commentCell, dateCell);
                            tableBody.append(row);

                            replies.forEach(function(reply){
                                if(reply.pcommentId === comment.commentId){
                                    var row = $("<tr>")
                                    var writerCell = $("<td>").attr("style","padding-left:30px;").html("<strong>"+reply.commenter + ":");
                                    var commentCell = $("<td>").text(reply.comment);
                                    var dateCell = $("<td>").text(formatDate(reply.regDate));
                                    row.append(writerCell, commentCell, dateCell);
                                    tableBody.append(row);
                                }
                            });
                        });
                    },
                });
            });
        });
    </script>
</head>
<body>
<div class="container" style="max-width: 400px">
    <!--프로젝트 로고-->
    <div class="text-center mt-5">
        <a th:href="@{/boards}"><h1><strong th:text="#{project.title}"></strong></h1></a>
        <hr class="my-1">
        <h6><strong th:text="#{project.subtitle}">project by KimYeJin</strong></h6>
    </div>
    <!--/프로젝트 로고-->
</div>

<div class="container" style="max-width: 350px" th:object="${board}">
    <!--게시 성공 문구-->
    <div class="text-center pt-2">
        <h5 style="color:gray;"><strong th:if="${param.status}" th:text="#{project.board.success}"></strong></h5>
    </div>
    <!--/게시 성공 문구-->

    <!--게시글 편집, 삭제 버튼-->
    <div th:if="${status}" class="row">
        <div class="col">
            <button class="btn btn-dark btn-sm float-end mb-1 mx-1" th:text="#{label.button.delete}"
                    data-bs-target="#deleteModal" data-bs-toggle="modal" type="button">delete
            </button>
            <button class="btn btn-warning btn-sm float-end mb-1 mx-1" th:text="#{label.button.edit}"
                    th:onclick="|location.href='@{/boards/edit/{boardId}(boardId=${board.boardId})}'|"
                    type="button">edit
            </button>
        </div>
    </div>
    <!--/게시글 편집, 삭제 버튼-->

    <!--게시글 이미지-->
    <img th:if="${board.getImgName()} != 'default' "
         th:src="|/boards/images/${board.getImgName()}|" class="img-fluid my-2"/>
    <!--/게시글 이미지-->

    <!--게시글 상세내용-->
    <input id="boardId" type="hidden" th:value="*{boardId}"/>
    <input type="text" class="form-control my-1" id="title" th:field="*{title}" readonly>
    <textarea class="form-control my-1" id="body" rows="10" th:field="*{body}" readonly></textarea>
    <!--/게시글 상세내용-->
</div>

<!--댓글 컨테이너, 목록 버튼-->
<div class="container" style="max-width: 400px">
    <div>
        <table id="commentTable" class="table text-center fs-13">
            <tbody id="commentTableBody">
            <div th:each="comment : ${comments}">
            <tr th:if="${comment.pcommentId == null}">
                <!-- 댓글 표시 -->
                <td><strong th:text="${comment.commenter} + ':'">작성자</strong></td>
                <td th:text="${comment.comment}">댓글 내용</td>
                <td th:utext="${#dates.format(comment.regDate, 'yyyy-MM-dd')}">등록일</td>
            </tr>
            <!-- 대댓글 표시 -->
            <tr th:each="reply : ${replies}" th:if="${reply.pcommentId == comment.commentId}">
                <td style="padding-left: 30px;"><strong th:text="${reply.commenter} + ':'">작성자</strong></td>
                <td th:text="${reply.comment}">대댓글 내용</td>
                <td th:utext="${#dates.format(reply.regDate, 'yyyy-MM-dd')}">등록일</td>
            </tr>
            </div>
            </tbody>
            <tfoot>
            <td colspan="4">
                <div class="input-group">
                    <input type="text" class="form-control input-style" id="commentData" th:placeholder="#{label.input.board.reply}"
                           placeholder="Reply" aria-label="Recipient's username" aria-describedby="commentButton">
                    <button class="btn btn-warning" type="button" style="font-size:14px;" id="commentButton"
                            th:text="#{label.button.ok}">OK
                    </button>
                </div>
            </td>
            </tfoot>
        </table>
    </div>


    <div class="row">
        <div class="col">
            <button class="btn btn-dark btn-sm float-start mb-1 mx-1" th:text="#{label.button.gotolist}"
                    th:onclick="|location.href='@{/boards}'|"
                    type="button">Go to List
            </button>
        </div>
    </div>
</div>
<!--/댓글 컨테이너, 목록 버튼-->

<!-- 게시글 삭제 확인 Modal -->
<div class="modal" tabindex="-1" id="deleteModal">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" th:text="#{modal.title.delete}">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <h6 th:text="#{modal.body.delete}">Do you really want to delete?</h6>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-dark btn-sm" data-bs-dismiss="modal"
                        th:text="#{label.button.cancel}">Cancel
                </button>
                <button type="button" class="btn btn-warning btn-sm" th:text="#{label.button.delete}"
                        th:onclick="|location.href='@{/boards/delete/{boardId}(boardId=${board.boardId})}'|"
                        onclick="location.href='index2.html'">OK
                </button>
            </div>
        </div>
    </div>
</div>
<!--/게시글 삭제 확인 modal-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
</body>
</html>